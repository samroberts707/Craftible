---
- name: Provision server
  hosts: all
  remote_user: root

  tasks:
  - name: Add latest php apt repository into sources list
    ansible.builtin.apt_repository:
      repo: ppa:ondrej/php
      state: present

  - name: Install APT packages
    ansible.builtin.apt:
      name: "{{ item }}"
      state: present
      update_cache: true
    with_items:
     - apache2
     - mysql-server
     - python3-pip
     - php8.3
     - libapache2-mod-php8.3
     - php8.3-mysql
     - php8.3-bcmath
     - php8.3-curl
     - php8.3-zip
     - php8.3-dom
     - php8.3-simplexml
     - php8.3-mbstring
     - php8.3-gd
     - php8.3-intl
     - php8.3-soap
  
  - name: Enable UFW Firewall
    ufw:
      rule: allow
      name: "{{ item }}"
      direction: in
      state: enabled
    with_items:
      - OpenSSH
      - Apache Full
      # TODO - Change this to "Apache Secure" once playbook is done

  - name: Make sure pymysql is present
    pip:
      name: pymysql
      state: present

  - name: Create Database User "craft" for CMS
    mysql_user:
      name: "{{ mysql_user }}"
      password: "{{ mysql_password }}"
      priv: '*.*:ALL'
      state: present
      login_unix_socket: /var/run/mysqld/mysqld.sock
  
  - name: Generate /root/.ssh/ RSA host key
    openssh_keypair:
      path: /root/.ssh/id_rsa
      owner: root
      group: root

  - name: Fix owner of the generated pub key
    file:
      path: /root/.ssh/id_rsa.pub
      owner: root
      group: root

  - name: Create project directory
    ansible.builtin.file:
      path: "/var/www/html/{{ project_name }}"
      state: directory
      owner: www-data
      group: www-data
      mode: 0775
